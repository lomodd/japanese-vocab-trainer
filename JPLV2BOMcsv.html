<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ—¥è¯­å•è¯è®°å¿†å·¥å…· â€” ç¾åŒ–ç‰ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* å°å¢å¼ºï¼šä½¿è¡¨æ ¼å¯æ¨ªå‘æ»šåŠ¨åœ¨å°å±å¹• */
    .table-wrapper { overflow-x:auto; }
  </style>
</head>
<body class="bg-gradient-to-b from-gray-100 to-gray-50 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl sm:text-3xl font-bold">ğŸ“˜ æ—¥è¯­å•è¯è®°å¿†å·¥å…·</h1>
        <div class="text-sm text-gray-500">æœ¬åœ°å­˜å‚¨ Â· æ— éœ€ç½‘ç»œ</div>
      </div>

      <!-- æ“ä½œæ  -->
      <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="col-span-2">
          <div class="flex gap-2">
            <input id="word" placeholder="æ—¥è¯­å•è¯ï¼ˆä¾‹å¦‚ï¼šã‚ã‚ŠãŒã¨ã†ï¼‰" class="flex-1 border rounded-lg p-2" />
            <input id="meaning" placeholder="é‡Šä¹‰ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰" class="flex-1 border rounded-lg p-2" />
            <button id="addBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">æ·»åŠ </button>
          </div>
          <div class="mt-2 text-xs text-gray-500">å»ºè®®ï¼šå•è¯+ç®€çŸ­é‡Šä¹‰ï¼ˆä¾¿äºå¿«é€Ÿè¾“å…¥/æ ¡éªŒï¼‰</div>
        </div>

        <div class="flex flex-col gap-2">
          <div class="flex gap-2">
            <button id="exportBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg">å¯¼å‡ºå¤‡ä»½</button>
            <label class="bg-white border rounded-lg px-3 py-2 flex items-center cursor-pointer hover:shadow">
              å¯¼å…¥
              <input id="importFile" type="file" accept=".json" class="hidden" />
            </label>
          </div>
          <div class="flex gap-2">
            <button id="clearAllBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            <button id="themeToggle" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-lg text-sm">é‡ç½®ç»Ÿè®¡</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid gap-6 sm:grid-cols-2">

      <!-- å·¦ä¾§ï¼šç®¡ç† / åˆ—è¡¨ -->
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">ğŸ“‹ å•è¯ç®¡ç†</h2>
          <div class="text-sm text-gray-500">æ€»æ•°ï¼š<span id="totalCount">0</span></div>
        </div>

        <div class="table-wrapper">
          <table class="w-full text-sm border-collapse">
            <thead>
              <tr class="bg-gray-50 text-left">
                <th class="px-3 py-2 border">æ—¥è¯­</th>
                <th class="px-3 py-2 border">é‡Šä¹‰</th>
                <th class="px-3 py-2 border">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="wordList"></tbody>
          </table>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="exportCSV" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm">å¯¼å‡º CSV</button>
          <button id="editModeBtn" class="bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg text-sm">æ‰¹é‡ç¼–è¾‘ï¼ˆæœªé€‰ï¼‰</button>
        </div>
      </div>

      <!-- å³ä¾§ï¼šå¤ä¹  / é”™é¢˜ / ç»Ÿè®¡ -->
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-lg font-semibold mb-3">ğŸ” å¤ä¹ æ¨¡å¼</h2>

        <div class="flex gap-2 mb-3">
          <button id="reviewAll" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg">å¤ä¹ å…¨éƒ¨</button>
          <button id="reviewWrong" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg">å¤ä¹ é”™é¢˜æœ¬</button>
        </div>

        <div id="quizCard" class="border rounded-lg p-4">
          <div id="quizWord" class="text-2xl font-bold mb-2 text-gray-800">è¯·é€‰æ‹©å¤ä¹ æ¨¡å¼å¼€å§‹</div>
          <input id="answer" placeholder="è¾“å…¥é‡Šä¹‰åç‚¹å‡»æ£€æŸ¥ï¼ˆEnter ä¹Ÿå¯ï¼‰" class="w-full border rounded-lg p-2 mb-3" />
          <div class="flex gap-2">
            <button id="checkBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">æ£€æŸ¥</button>
            <button id="nextBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">ä¸‹ä¸€é¢˜</button>
            <button id="showAnswer" class="ml-auto bg-yellow-400 hover:bg-yellow-500 text-black px-3 py-2 rounded-lg text-sm">æ˜¾ç¤ºç­”æ¡ˆ</button>
          </div>
          <div id="result" class="mt-3 font-medium"></div>
        </div>

        <div class="mt-5">
          <h3 class="font-semibold mb-2">ğŸ“š é”™é¢˜æœ¬ <span class="text-sm text-gray-500">ï¼ˆå¯å•ç‹¬å¤ä¹ /æ¸…ç©ºï¼‰</span></h3>
          <ul id="wrongList" class="list-disc pl-5 text-red-600 max-h-36 overflow-auto"></ul>
          <div class="mt-2 flex gap-2">
            <button id="clearWrongBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">æ¸…ç©ºé”™é¢˜æœ¬</button>
            <button id="removeWrongFromListBtn" class="bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg text-sm">ä»é”™é¢˜æœ¬ç§»é™¤å·²è®°ä½</button>
          </div>
        </div>

        <div class="mt-5">
          <h3 class="font-semibold mb-2">ğŸ“ˆ ä»Šæ—¥è¿›åº¦</h3>
          <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
            <div id="progressBar" class="bg-green-500 h-4 rounded-full" style="width:0%"></div>
          </div>
          <div class="text-sm text-gray-600" id="todayStats">ä»Šæ—¥å·²å¤ä¹  0 / 20 é¢˜ï¼Œæ­£ç¡®ç‡ 0%</div>
          <div class="mt-2 text-xs text-gray-500">ç›®æ ‡é¢˜æ•°ï¼ˆå¯æ”¹ï¼‰ï¼š<input id="dailyGoal" type="number" class="w-20 border rounded px-2 py-1 ml-2" value="20" /></div>
        </div>
      </div>

    </div>

    <!-- ç¼–è¾‘æ¨¡æ€ -->
    <div id="editModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
      <div class="bg-white rounded-xl p-6 w-full max-w-xl shadow-xl">
        <h3 class="text-lg font-semibold mb-3">ç¼–è¾‘å•è¯</h3>
        <div class="flex gap-2">
          <input id="editWordInput" class="flex-1 border rounded-lg p-2" />
          <input id="editMeaningInput" class="flex-1 border rounded-lg p-2" />
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button id="cancelEdit" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200">å–æ¶ˆ</button>
          <button id="saveEdit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div class="mt-6 text-xs text-gray-400 text-center">æç¤ºï¼šæŒ‰ Enter å¯æäº¤ç­”æ¡ˆ / æ·»åŠ å•è¯ã€‚æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ï¼Œä¸ä¼šä¸Šä¼ ã€‚</div>
  </div>

<script>
/* ==========================
   æœ¬åœ°å­˜å‚¨é”®ä¸åˆå§‹è®¾ç½®
   ========================== */
const KEY_WORDS = 'jpWords_v1';
const KEY_WRONG = 'jpWrongBook_v1';
const KEY_DAILY = 'jpDailyStats_v1';

let words = JSON.parse(localStorage.getItem(KEY_WORDS)) || [];
let wrongBook = JSON.parse(localStorage.getItem(KEY_WRONG)) || {};
// wrongBook as object keyed by word for easy dedupe: { "ã‚ã‚ŠãŒã¨ã†": {word, meaning} }
let dailyStats = JSON.parse(localStorage.getItem(KEY_DAILY)) || {};

const todayKey = new Date().toISOString().split('T')[0];
if (!dailyStats[todayKey]) dailyStats[todayKey] = { total: 0, correct: 0 };

let currentWord = null;
let reviewWrongOnly = false;

/* ==========================
   DOM refs
   ========================== */
const wordInput = document.getElementById('word');
const meaningInput = document.getElementById('meaning');
const addBtn = document.getElementById('addBtn');
const wordListTbody = document.getElementById('wordList');
const totalCount = document.getElementById('totalCount');
const reviewAllBtn = document.getElementById('reviewAll');
const reviewWrongBtn = document.getElementById('reviewWrong');
const quizWord = document.getElementById('quizWord');
const answerInput = document.getElementById('answer');
const checkBtn = document.getElementById('checkBtn');
const nextBtn = document.getElementById('nextBtn');
const resultDiv = document.getElementById('result');
const wrongListElm = document.getElementById('wrongList');
const clearWrongBtn = document.getElementById('clearWrongBtn');
const progressBar = document.getElementById('progressBar');
const todayStats = document.getElementById('todayStats');
const dailyGoalInput = document.getElementById('dailyGoal');
const exportBtn = document.getElementById('exportBtn');
const importFile = document.getElementById('importFile');
const clearAllBtn = document.getElementById('clearAllBtn');
const exportCSV = document.getElementById('exportCSV');
const editModal = document.getElementById('editModal');
const editWordInput = document.getElementById('editWordInput');
const editMeaningInput = document.getElementById('editMeaningInput');
const saveEditBtn = document.getElementById('saveEdit');
const cancelEditBtn = document.getElementById('cancelEdit');
const showAnswerBtn = document.getElementById('showAnswer');
const removeWrongFromListBtn = document.getElementById('removeWrongFromListBtn');

/* ==========================
   å·¥å…·å‡½æ•°ï¼šä¿å­˜ä¸æ¸²æŸ“
   ========================== */
function persist() {
  localStorage.setItem(KEY_WORDS, JSON.stringify(words));
  localStorage.setItem(KEY_WRONG, JSON.stringify(wrongBook));
  localStorage.setItem(KEY_DAILY, JSON.stringify(dailyStats));
  renderAll();
}

function renderAll() {
  renderWords();
  renderWrongBook();
  updateCountsAndStats();
}

function renderWords() {
  wordListTbody.innerHTML = '';
  if (words.length === 0) {
    wordListTbody.innerHTML = `<tr><td class="px-3 py-2 border" colspan="3"><div class="text-gray-400">å½“å‰æ²¡æœ‰å•è¯ â€” è¯·åœ¨ä¸Šæ–¹æ·»åŠ </div></td></tr>`;
    totalCount.innerText = 0;
    return;
  }
  words.forEach((w, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-3 py-2 border align-top">${escapeHtml(w.word)}</td>
      <td class="px-3 py-2 border align-top">${escapeHtml(w.meaning)}</td>
      <td class="px-3 py-2 border align-top">
        <div class="flex gap-2">
          <button class="py-1 px-2 text-sm bg-yellow-100 hover:bg-yellow-200 rounded" data-action="edit" data-idx="${idx}">ç¼–è¾‘</button>
          <button class="py-1 px-2 text-sm bg-red-100 hover:bg-red-200 rounded" data-action="delete" data-idx="${idx}">åˆ é™¤</button>
          <button class="py-1 px-2 text-sm bg-blue-100 hover:bg-blue-200 rounded" data-action="add-wrong" data-idx="${idx}">åŠ å…¥é”™é¢˜</button>
        </div>
      </td>
    `;
    wordListTbody.appendChild(tr);
  });
  totalCount.innerText = words.length;
}

function renderWrongBook() {
  wrongListElm.innerHTML = '';
  const arr = Object.values(wrongBook || {});
  if (arr.length === 0) {
    wrongListElm.innerHTML = '<li class="text-gray-400">é”™é¢˜æœ¬ä¸ºç©º</li>';
    return;
  }
  arr.forEach(w => {
    const li = document.createElement('li');
    li.innerHTML = `${escapeHtml(w.word)} - ${escapeHtml(w.meaning)} <button class="ml-3 text-xs text-blue-600" data-action="remove-wrong" data-word="${escapeHtml(w.word)}">(ç§»é™¤)</button>`;
    wrongListElm.appendChild(li);
  });
}

function updateCountsAndStats() {
  // é”™é¢˜æ•°æ˜¾ç¤ºåœ¨é”™é¢˜åŒºåŸŸï¼ŒåŒæ—¶ totalCount å·²æœ‰
  // æ›´æ–°ä»Šæ—¥è¿›åº¦
  const goal = parseInt(dailyGoalInput.value) || 20;
  const stats = dailyStats[todayKey] || { total: 0, correct: 0 };
  const percent = Math.min(Math.round((stats.total / goal) * 100), 100);
  const accuracy = stats.total ? Math.round((stats.correct / stats.total) * 100) : 0;
  progressBar.style.width = percent + '%';
  todayStats.innerText = `ä»Šæ—¥å·²å¤ä¹  ${stats.total} / ${goal} é¢˜ï¼Œæ­£ç¡®ç‡ ${accuracy}% ï¼ˆå‡†ç¡®ç‡å«â€œæ¥è¿‘æ­£ç¡®â€ï¼‰`;
}

/* ==========================
   äº‹ä»¶ï¼šæ·»åŠ  / ç¼–è¾‘ / åˆ é™¤
   ========================== */
addBtn.addEventListener('click', () => {
  const w = wordInput.value.trim();
  const m = meaningInput.value.trim();
  if (!w || !m) { alert('è¯·è¾“å…¥æ—¥è¯­å•è¯å’Œé‡Šä¹‰'); return; }
  words.push({ word: w, meaning: m });
  wordInput.value = ''; meaningInput.value = '';
  persist();
});

wordListTbody.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const action = btn.dataset.action;
  const idx = Number(btn.dataset.idx);
  if (action === 'delete') {
    if (!confirm('ç¡®å®šåˆ é™¤è¯¥å•è¯ï¼Ÿ')) return;
    words.splice(idx, 1);
    persist();
  } else if (action === 'edit') {
    openEditModal(idx);
  } else if (action === 'add-wrong') {
    const item = words[idx];
    wrongBook[item.word] = item;
    persist();
  }
});

/* ==========================
   ç¼–è¾‘æ¨¡æ€
   ========================== */
let editingIndex = -1;
function openEditModal(idx) {
  editingIndex = idx;
  editWordInput.value = words[idx].word;
  editMeaningInput.value = words[idx].meaning;
  editModal.classList.remove('hidden');
  editModal.style.display = 'flex';
}
cancelEditBtn.addEventListener('click', closeEditModal);
saveEditBtn.addEventListener('click', () => {
  const w = editWordInput.value.trim();
  const m = editMeaningInput.value.trim();
  if (!w || !m) { alert('è¯·è¾“å…¥æ—¥è¯­å•è¯å’Œé‡Šä¹‰'); return; }
  words[editingIndex] = {word: w, meaning: m};
  closeEditModal();
  persist();
});
function closeEditModal() {
  editModal.classList.add('hidden');
  editModal.style.display = 'none';
}

/* ç‚¹å‡»æ¨¡æ€èƒŒæ™¯ä¹Ÿå…³é—­ */
editModal.addEventListener('click', (e) => {
  if (e.target === editModal) closeEditModal();
});

/* ==========================
   å¤ä¹ æµç¨‹
   ========================== */
reviewAllBtn.addEventListener('click', () => startReview(false));
reviewWrongBtn.addEventListener('click', () => startReview(true));

function startReview(onlyWrong) {
  reviewWrongOnly = onlyWrong;
  const pool = onlyWrong ? Object.values(wrongBook) : words;
  if (!pool || pool.length === 0) { alert(onlyWrong ? 'é”™é¢˜æœ¬ä¸ºç©º' : 'å•è¯è¡¨ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å•è¯'); return; }
  nextQuestion();
}

function nextQuestion() {
  const pool = reviewWrongOnly ? Object.values(wrongBook) : words;
  if (!pool || pool.length === 0) { alert('å½“å‰é¢˜åº“ä¸ºç©º'); return; }
  currentWord = pool[Math.floor(Math.random() * pool.length)];
  quizWord.innerText = currentWord ? currentWord.word : 'â€”';
  answerInput.value = '';
  resultDiv.innerText = '';
  answerInput.focus();
}

checkBtn.addEventListener('click', checkAnswer);
answerInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') checkAnswer();
});
nextBtn.addEventListener('click', nextQuestion);
showAnswerBtn.addEventListener('click', () => {
  if (!currentWord) return;
  resultDiv.innerHTML = `<span class="text-yellow-700">ç­”æ¡ˆï¼š${escapeHtml(currentWord.meaning)}</span>`;
});

/* æ£€æŸ¥ç­”æ¡ˆï¼šä¸¥æ ¼åŒ¹é… -> ç›¸ä¼¼åº¦ >= 0.8 ä¸ºæ¥è¿‘æ­£ç¡® -> å¦åˆ™é”™è¯¯ï¼ˆåŠ å…¥é”™é¢˜ï¼‰ */
function checkAnswer() {
  if (!currentWord) return alert('è¯·å…ˆå¼€å§‹å¤ä¹ å¹¶æ˜¾ç¤ºé¢˜ç›®');
  const ans = answerInput.value.trim();
  // è®°å½•ç»ƒä¹ æ¬¡æ•°ï¼ˆæ¯å¤©ï¼‰
  dailyStats[todayKey].total = (dailyStats[todayKey].total || 0) + 1;

  if (ans === currentWord.meaning) {
    dailyStats[todayKey].correct = (dailyStats[todayKey].correct || 0) + 1;
    resultDiv.innerHTML = `<span class="text-green-700">âœ… å®Œå…¨æ­£ç¡®</span>`;
  } else {
    const sim = stringSimilarity(ans, currentWord.meaning);
    if (sim >= 0.8) {
      dailyStats[todayKey].correct = (dailyStats[todayKey].correct || 0) + 1;
      resultDiv.innerHTML = `<span class="text-amber-700">âš  æ¥è¿‘æ­£ç¡®ï¼ˆç›¸ä¼¼åº¦ ${(sim*100).toFixed(0)}%ï¼‰ â€” ç­”æ¡ˆï¼š${escapeHtml(currentWord.meaning)}</span>`;
    } else {
      // é”™è¯¯ï¼šåŠ å…¥é”™é¢˜æœ¬ï¼ˆå»é‡ï¼‰
      wrongBook[currentWord.word] = currentWord;
      resultDiv.innerHTML = `<span class="text-red-600">âŒ é”™è¯¯ â€” ç­”æ¡ˆï¼š${escapeHtml(currentWord.meaning)}</span>`;
    }
  }
  persist();
}

/* ==========================
   é”™é¢˜æœ¬ æ“ä½œ
   ========================== */
clearWrongBtn.addEventListener('click', () => {
  if (!confirm('ç¡®å®šæ¸…ç©ºé”™é¢˜æœ¬å—ï¼Ÿ')) return;
  wrongBook = {};
  persist();
});

wrongListElm.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const action = btn.dataset.action;
  if (action === 'remove-wrong') {
    const w = btn.dataset.word;
    delete wrongBook[w];
    persist();
  }
});

removeWrongFromListBtn.addEventListener('click', () => {
  // ä»é”™é¢˜æœ¬åˆ é™¤é‚£äº›å·²åœ¨ä¸»å•è¯è¡¨ä¸­å¹¶ä¸”è®¤ä¸ºå·²ç»è®°ä½ï¼ˆä¾‹å¦‚ï¼šä½ è¾“å…¥äº†æ­£ç¡®ç­”æ¡ˆçš„å•è¯ï¼‰ï¼Œè¿™é‡Œåªç»™ä¸ªæ‰‹åŠ¨æ“ä½œï¼šåˆ é™¤æ‰€æœ‰å‡ºç°åœ¨ä¸»è¡¨ä¸­çš„å•è¯
  const mainWordsSet = new Set(words.map(w => w.word));
  let removed = 0;
  for (const k of Object.keys(wrongBook)) {
    if (mainWordsSet.has(k)) { delete wrongBook[k]; removed++; }
  }
  if (removed === 0) alert('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å•è¯å¯ç§»é™¤');
  persist();
});

/* ==========================
   å¯¼å…¥ / å¯¼å‡º / æ¸…ç©º
   ========================== */
exportBtn.addEventListener('click', () => {
  // å¯¼å‡ºåŒ…å« words, wrongBook, dailyStatsï¼ˆä¾¿äºæ¢å¤ï¼‰
  const payload = {
    exportedAt: new Date().toISOString(),
    words,
    wrongBook,
    dailyStats
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `jp_words_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

importFile.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!confirm('å¯¼å…¥ä¼šåˆå¹¶åˆ°å½“å‰å•è¯è¡¨ï¼ˆåŒä¸€å•è¯ä»¥å¯¼å…¥æ–‡ä»¶ä¸ºå‡†ï¼‰ã€‚ç¡®è®¤ç»§ç»­ï¼Ÿ')) { importFile.value = ''; return; }
      // åˆå¹¶ wordsï¼ˆä»¥ word å­—æ®µä¸º keyï¼Œå¯¼å…¥æ–‡ä»¶ä¼˜å…ˆï¼‰
      const map = {};
      words.forEach(w => map[w.word] = w);
      if (Array.isArray(data.words)) data.words.forEach(w => map[w.word] = w);
      words = Object.values(map);
      // åˆå¹¶é”™é¢˜æœ¬ï¼ˆimport winsï¼‰
      if (data.wrongBook) wrongBook = {...wrongBook, ...data.wrongBook};
      // åˆå¹¶ dailyStatsï¼ˆè¦†ç›–/åˆå¹¶ï¼‰
      if (data.dailyStats) dailyStats = {...dailyStats, ...data.dailyStats};
      persist();
      alert('å¯¼å…¥å®Œæˆ');
    } catch (err) {
      console.error(err);
      alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
    } finally {
      importFile.value = '';
    }
  };
  reader.readAsText(file);
});

clearAllBtn.addEventListener('click', () => {
  if (!confirm('ç¡®å®šæ¸…ç©ºæœ¬å·¥å…·çš„æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿï¼ˆå•è¯ã€é”™é¢˜ã€ç»Ÿè®¡ï¼‰')) return;
  words = []; wrongBook = {}; dailyStats = {}; dailyStats[todayKey] = { total:0, correct:0 };
  persist();
});

/* å¯¼å‡º CSV */
exportCSV.addEventListener('click', () => {
  if (!words || words.length === 0) { alert('å•è¯è¡¨ä¸ºç©º'); return; }
  const rows = [['æ—¥è¯­','é‡Šä¹‰'], ...words.map(w => [w.word, w.meaning])];
  const csv = rows.map(r => r.map(c => `"${(c+'').replaceAll('"','""')}"`).join(',')).join('\n');
  // åŠ ä¸Š UTF-8 BOM
  const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
  const csvArray = new TextEncoder().encode(csv);
  const blob = new Blob([bom, csvArray], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `jp_words_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  URL.revokeObjectURL(url);
});


/* ==========================
   å°å·¥å…·ï¼šç›¸ä¼¼åº¦ï¼ˆLevenshteinï¼‰
   ========================== */
function stringSimilarity(a, b) {
  if (!a && !b) return 1;
  a = (a||'').toLowerCase();
  b = (b||'').toLowerCase();
  const d = levenshtein(a, b);
  const maxLen = Math.max(a.length, b.length);
  return maxLen === 0 ? 1 : (1 - d / maxLen);
}
function levenshtein(a, b) {
  const la = a.length, lb = b.length;
  if (la === 0) return lb;
  if (lb === 0) return la;
  const dp = Array.from({length: la + 1}, () => new Array(lb + 1).fill(0));
  for (let i=0;i<=la;i++) dp[i][0]=i;
  for (let j=0;j<=lb;j++) dp[0][j]=j;
  for (let i=1;i<=la;i++){
    for (let j=1;j<=lb;j++){
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
    }
  }
  return dp[la][lb];
}

/* ==========================
   è¾…åŠ©ï¼šè½¬ä¹‰ HTMLï¼ˆé˜²æ³¨å…¥ï¼‰ & escape
   ========================== */
function escapeHtml(s) {
  if (!s) return '';
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

/* ==========================
   åˆå§‹åŒ–æ¸²æŸ“
   ========================== */
renderAll();

/* ==========================
   å°æç¤ºï¼šå›è½¦å¿«æ·é”®ï¼ˆæ·»åŠ å•è¯ï¼‰
   ========================== */
meaningInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') addBtn.click();
});

/* è¾“å…¥ç­”æ¡ˆå¹¶ç»Ÿè®¡åè‡ªåŠ¨ä¸‹ä¸€é¢˜ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚éœ€è‡ªåŠ¨ä¸‹ä¸€é¢˜ï¼Œè¯·åœ¨ checkAnswer æœ«å°¾è°ƒç”¨ nextQuestion() */
// â€” ä»¥ä¸Šä¸ºå®Œæ•´åŠŸèƒ½ä»£ç 
</script>
</body>
</html>
